{% extends "dashboard/fadama/base.html" %}

{% block content %}
    {{ block.super }}

<script src="{{ STATIC_URL }}js/knockout-2.1.0.js"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script>

if (!window.console) {
    window.console = {
        log: function () { }
    };
}

DEFAULT_SITE = {{ default_site|default:"null" }};
DEFAULT_METRIC = "{{ default_metric }}";

$(document).ready(function() {
    detail_report_init();
  });

charts_init = false;
google.load('visualization', '1', { packages: ['corechart'] });

function detail_report_init() {
  var model = new FadamaDetailViewModel();
  ko.applyBindings(model);

  google.setOnLoadCallback(function() {
    model.active_month(model.active_month());
    charts_init = true;
  });
}

function FadamaDetailViewModel() {
  this.monthly = ko.observableArray();
  this.facilities = ko.observableArray();
  this.__all_clinics = new FacilityModel({id: -1, name: 'All Sites'});

  this.active_facility = ko.observable();
  this.active_metric = ko.observable(DEFAULT_METRIC || null);
  this.active_month = ko.observable();

  this.load = function(data) {
    if (this.facilities().length == 0) {
      var facs = $.map(data.facilities, function(f) {
          return new FacilityModel(f);
        })
      facs.splice(0, 0, this.__all_clinics);
      this.facilities(facs);

      var default_facility = this.facility_by_id(DEFAULT_SITE);
      if (default_facility) {
        this.active_metric('satisf');
        this.active_facility(default_facility);
      }
    }

    var active_month_ix = (this.active_month() ? this.monthly.indexOf(this.active_month()) : -1);
    this.monthly($.map(data.monthly, function(m) {
        return new MonthlyDetailModel(m);
      }));
    this.active_month(this.monthly.slice(active_month_ix)[0]);
  };

  this.ajax_load = function(facility_id) {
    var params = facility_id != null ? {site: facility_id} : {};
    var model = this;
    $.get('/dashboard/fadama/api/detail', params, function(data) {
        console.log(params, data);
        model.load(data);
      }, 'json');
  }

  this.prevmonth = function() {
    this.month_incr(-1);
  }

  this.nextmonth = function() {
    this.month_incr(1);
  }

  this.month_incr = function(k) {
    var i = this.monthly.indexOf(this.active_month());
    i += k;
    if (i >= this.monthly().length) {
      i = this.monthly().length - 1;
    } else if (i <= 0) {
      i = 0;
    }
    this.active_month(this.monthly()[i]);
  }

  this.is_metric_active = function(code) {
    return (this.active_metric() == 'all' || this.active_metric() == code);
  }

  var model = this;
  this._facility_reload = ko.computed(function() {
      var fac = model.active_facility();
      model.ajax_load(fac != null && fac.id() != -1 ? fac.id() : null);
    });

  this.facility_by_id = function(id) {
    var f = null;
    $.each(this.facilities(), function(i, e) {
        if (id != null && e.id() == id) {
          f = e;
          return false;
        }
      });
    return f;
  }
}

function FacilityModel(data) {
  this.id = ko.observable(data.id);
  this.name = ko.observable(data.name);
}

function MonthlyDetailModel(data) {
  this.logs = ko.observableArray($.map(data.logs, function(l) {
      return new LogModel(l);
    }));
  this.month_label = ko.observable(data.month);
  this.stats = data.stats;
  this.clinic_totals = data.clinic_totals;
}

function LogModel(data) {
  this.id = ko.observable(data.id);
  this.site = ko.observable(data.site_name);
  this.date = ko.observable(data.display_time);
  this.satisfied = ko.observable(data.satisfied);

  var categories = ['serviceprovider', 'people', 'land', 'info', 'ldp', 'financial'];
  var category = null;
  $.each(categories, function(i, e) {
      if (data[e] != null) {
        category = e;
        return false;
      }
    });
  
  this.category = ko.observable(category);
  this.subcategory = ko.observable(data[category]);
  this.message = ko.observable(data.message);

  var model = this;
  this.category_caption = ko.computed(function() {
      return {
        'serviceprovider': 'Service Providers',
        'people': 'Stakeholders',
        'land': 'Land Issues',
        'info': 'Lack of Information',
        'ldp': 'LDP Approval',
        'financial': 'Financial Issues',
      }[model.category()];
    });
  this.subcategory_caption = ko.computed(function() {
      return get_caption(model.category(), model.subcategory());
    });
}

ko.bindingHandlers.yn = {
  update: function(element, valueAccessor, allBindingsAccessor, viewModel) {
    var val = ko.utils.unwrapObservable(valueAccessor());

    $(element).empty();
    if (val != null) {
      var $img = $('<img />');
      $img.attr('src', 'http://whereis.dimagi.com/staticmedia/admin/img/icon_' + (val ? 'success' : 'error') + '.gif');
      $(element).append($img);
    }

  }
};

function get_caption(metric, value) {
  return {
    satisf: {
      True: 'Satisfied',
      False: 'Unsatisfied',
    },
    serviceprovider: {
      notfind: 'Not Finding',
      notstarted: 'Not Started',
      delay: 'Delays',
      stopped: 'Abandoned Project',
      substandard: 'Substandard Service',
      other: 'Other',
    },
    people: {
      state: 'State Officials',
      fug: 'FUG',
      fca: 'FCA',
      facilitator: 'Facilitators',
      other: 'Other',
    },
    land: {
      notfind: 'Not Finding',
      suitability: 'Not Suitable',
      ownership: 'Ownership',
      other: 'Other',
    },
    info: {
      market: 'Market',
      input: 'Input',
      credit: 'Access to Credit',
      other: 'Other',
    },
    ldp: {
      delay: 'Delays',
      other: 'Other',
    },
    financial: {
      bank: 'Bank Account Opening',
      delay: 'Delayed Funding',
      other: 'Other',
    },
  }[metric][value];
}

function get_ordering(metric) {
  return {
    satisf: ['True', 'False'],
    serviceprovider: ['notfind', 'notstarted', 'delay', 'stopped', 'substandard', 'other'],
    people: ['state', 'fug', 'fca', 'facilitator', 'other'],
    land: ['notfind', 'suitability', 'ownership', 'other'],
    info: ['market', 'input', 'credit', 'other'],
    ldp: ['delay', 'other'],
    financial: ['bank', 'delay', 'other'],
  }[metric];
}

function monthly_datapoints(month, metric) {
  var key = {
    satisf: 'satisfied',
  }[metric] || metric
  return month.stats[key];
}

ko.bindingHandlers.currentchart = {
  init: function(element, valueAccessor, allBindingsAccessor, viewModel) {
  },
  update: function(element, valueAccessor, allBindingsAccessor, viewModel) {
    var active = ko.utils.unwrapObservable(valueAccessor());
    var metric = viewModel.active_metric();
    if (!charts_init || !active || !metric || metric == 'all') {
      return;
    }

    var options = {
      vAxis: {
        textPosition: 'in'
      },
      chartArea: {
        top: 10,
        left: 0,
        width: '100%'
      },
    };

    var data = [['Category', '']];
    var raw_data = monthly_datapoints(active, metric);
    $.each(get_ordering(metric), function(i, e) {
        if (raw_data[e] != null) {
          data.push([get_caption(metric, e), raw_data[e]]);
        }
      });

    var chart_type = 'PieChart';

    var chart = new google.visualization[chart_type](element);
    chart.draw(google.visualization.arrayToDataTable(data), options);
  }
};

ko.bindingHandlers.historicalchart = {
  init: function(element, valueAccessor, allBindingsAccessor, viewModel) {
  },
  update: function(element, valueAccessor, allBindingsAccessor, viewModel) {
    var active = ko.utils.unwrapObservable(valueAccessor());
    var metric = viewModel.active_metric();
    if (!charts_init || !active || !metric || metric == 'all') {
      return;
    }

    var options = {
      vAxis: {
        textPosition: 'in'
      },
      chartArea: {
        top: 10,
        left: 0,
        width: '85%'
      },
    };

    var FUZZ = 2;
    var curmonthix = viewModel.monthly.indexOf(active);
    var minmonthix = curmonthix - 2;
    var maxmonthix = curmonthix + 2;

    var labels = ['Month'];
    var raw_data = monthly_datapoints(active, metric);
    $.each(get_ordering(metric), function(i, e) {
        labels.push(get_caption(metric, e));
      });
    var data = [labels];

    for (var i = minmonthix; i <= maxmonthix; i++) {
      var row = [];
      if (i < 0 || i >= viewModel.monthly().length) {
        row.push('');
        for (var j = 1; j < labels.length; j++) {
          row.push(null);
        }
      } else {
        var m = viewModel.monthly()[i];
        var raw_data = monthly_datapoints(m, metric);
        row.push(m.month_label());
        $.each(get_ordering(metric), function(i, e) {
            row.push(raw_data[e] || 0);
          });
      }
      data.push(row);
    }

    var chart = new google.visualization.ColumnChart(element);
    chart.draw(google.visualization.arrayToDataTable(data), options);
  }
};

ko.bindingHandlers.map_volume = {
  init: function(element, valueAccessor, allBindingsAccessor, viewModel) {
    var options = {
	center: new google.maps.LatLng(9.05, 8.35),
        zoom: 5,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    element.map = new google.maps.Map(element, options);
    element.ovl = [];
  },
  update: function(element, valueAccessor, allBindingsAccessor, viewModel) {
    var active = ko.utils.unwrapObservable(valueAccessor());
    if (!active) {
      return;
    }

    $.each(element.ovl, function(i, e) {
        e.setMap(null);
      });
    element.ovl = [];

    var bounds = new google.maps.LatLngBounds();
    $.each(active.clinic_totals, function(i, e) {
        var facility = e[0];
        var volume = e[1];

        var pos = new google.maps.LatLng(facility.lat, facility.lon);
        bounds.extend(pos);

        var circleOptions = {
          strokeColor: '#DA4F49',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: '#DA4F49',
          fillOpacity: 0.35,
          map: element.map,
          center: pos,
          radius: 1500 * Math.sqrt(volume)
        };

        var dotOptions = {
          strokeWeight: 0,
          fillColor: '#000000',
          fillOpacity: 0.6,
          map: element.map,
          center: pos,
          radius: 400
        };

        var circle = new google.maps.Circle(circleOptions);
        var dot = new google.maps.Circle(dotOptions);
        element.ovl.push(dot);
        element.ovl.push(circle);

        var select_clinic = function() {
	    var clinic = viewModel.facility_by_id(facility.id);
            viewModel.active_metric('satisf');
            viewModel.active_facility(clinic);
          };

        google.maps.event.addListener(circle, 'click', select_clinic);
        google.maps.event.addListener(dot, 'click', select_clinic);
      });
    element.map.fitBounds(bounds);
    var MAX_ZOOM = 12;
    if (element.map.getZoom() > MAX_ZOOM) {
      element.map.setZoom(MAX_ZOOM);
    }
  }
};



</script>

    <div class="row-fluid">
      <table class="date-control" style="float: right;">
	<tr>
	  <td style="width: 4em; vertical-align: top; text-align: left;">
            <a href="#" data-bind="click: prevmonth, style: { color: monthly().indexOf(active_month()) == 0 ? '#888' : '' }">Prev</a>
	  </td>
	  <td class="month" style="width: 8em; vertical-align: top; text-align: center;">
            <p data-bind="text: active_month() ? active_month().month_label() : ''"></p>
	  </td>
	  <td style="width: 4em; vertical-align: top; text-align: right;">
            <a href="#" data-bind="click: nextmonth, style: { color: monthly().indexOf(active_month()) == monthly().length - 1 ? '#888' : '' }">Next</a>
	  </td>
	</tr>
      </table>

        <div class="span8">
            <form id="detail-filter" class="form-inline filter-form">
                <label>Feedback on</label>
                <select data-bind="value: active_metric">
                    <option value="all">All Categories</option>
                    <option value="satisf">Overall Satisfaction</option>
                    <option value="serviceprovider">Service Providers</option>
                    <option value="people">Stakeholders</option>
                    <option value="land">Land Issues</option>
                    <option value="info">Lack of Information</option>
                    <option value="ldp">LDP Approval</option>
                    <option value="financial">Financial Issues</option>
                </select>
                <label>in</label>
                <select data-bind="options: facilities, value: active_facility, optionsText: 'name'" id="location">
                </select>
            </form>
        </div>
    </div>

    <div class="row-fluid" data-bind="visible: active_metric() != 'all'">
        <div class="span8">
            <h3>Reports by Month</h3>
            <p>
	      <div id="multi-month-chart" data-bind="historicalchart: active_month" class="chart"></div>
            </p>
        </div>
        <div class="span4">
            <h3>Beneficiaries reported&hellip;</h3>
            <p>
	      <div id="multi-month-chart" data-bind="currentchart: active_month" class="chart"></div>
            </p>
        </div>
    </div>

    <div class="row-fluid" data-bind="visible: active_metric() == 'all'">
        <div class="span12">
	  <div id="map" data-bind="map_volume: active_month" class="map"></div>
        </div>
    </div>

    <div class="row-fluid">
        <div class="span12">
            <span class="large">Detailed Reports</span>


<form class="form-inline filter-form" action="#">
    <label class="control-label" for="object_filter">Filter by:</label>
    <select data-bind="options: facilities, value: active_facility, optionsText: 'name'" id="location"></select>
    <select data-bind="value: active_metric" id="feedback">
                    <option value="all">All Categories</option>
                    <option value="satisf">Overall Satisfaction</option>
                    <option value="serviceprovider">Service Providers</option>
                    <option value="people">Stakeholders</option>
                    <option value="land">Land Issues</option>
                    <option value="info">Lack of Information</option>
                    <option value="ldp">LDP Approval</option>
                    <option value="financial">Financial Issues</option>
    </select>
    <input type="text" id="date" class="input-mini calendar" placeholder="Date" />
    <input type="text" id="search" placeholder="Search..." />
</form>


        </div>
    </div>

    <div class="row-fluid">
        <div class="span12">
            <table id="reports-table" class="table table-bordered table-striped table-condensed">
                <thead>
                    <tr>
                        <th>Report #</th>
                        <th style="width: 12em;">Site</th>
                        <th>Date &amp; Time</th>
                        <th>Patient Satisfied</th>
			<th>Feedback Category</th>
			<th>Sub-category</th>
			<th>Free-form message</th>
                    </tr>
                </thead>
                <tbody data-bind="foreach: active_month() ? active_month().logs() : []">
                    <tr data-bind="visible: category() == $root.active_metric() || $root.active_metric() == 'all' || $root.active_metric() == 'satisf'">
                        <td data-bind="text: id"></td>
                        <td data-bind="text: site"></td>
                        <td data-bind="text: date"></td>
                        <td data-bind="yn: satisfied"></td>
			<td data-bind="text: category_caption"></td>
			<td data-bind="text: subcategory_caption"></td>
			<td style="width: 25em;" data-bind="text: message"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
{% endblock content %}

