{% extends "dashboard/pbf/base.html" %}

{% block content %}
    {{ block.super }}

<script src="http://knockoutjs.com/js/knockout-2.1.0.js"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script>

if (!window.console) {
    window.console = {
        log: function () { }
    };
}

$(document).ready(function() {
    detail_report_init();
  });

function detail_report_init() {
  var model = new PBFDetailViewModel();
  ko.applyBindings(model);

  $.get('/dashboard/pbf/api/detail', function(data) {
      console.log(data);
      model.load(data);
    }, 'json');

}

function PBFDetailViewModel() {
  this.logs = ko.observableArray();
  this.facilities = ko.observableArray();
  this.__all_clinics = new FacilityModel({id: -1, name: 'All Clinics'});

  this.active_facility = ko.observable();
  this.active_metric = ko.observable();
  this.active_month = ko.observable();

  this.load = function(data) {
    this.facilities($.map(data.facilities, function(f) {
        return new FacilityModel(f);
      }));
    this.facilities.splice(0, 0, this.__all_clinics);
    this.active_facility(this.__all_clinics);
    this.logs($.map(data.logs, function(l) {
        return new LogModel(l);
      }));
    //this.active_month(this.stats.slice(-1)[0]);
  };

  this.prevmonth = function() {
    this.month_incr(-1);
  }

  this.month_incr = function(k) {
    var i = this.stats.indexOf(this.active_month());
    i += k;
    if (i >= this.stats().length) {
      i = this.stats().length - 1;
    } else if (i <= 0) {
      i = 0;
    }
    this.active_month(this.stats()[i]);
  }

  this.is_metric_active = function(code) {
    return (this.active_metric() == 'all' || this.active_metric() == code);
  }
}

function FacilityModel(data) {
  this.id = ko.observable(data.id);
  this.name = ko.observable(data.name);
}

function LogModel(data) {
  this.id = ko.observable(data.id);
  this.site = ko.observable(data.site_name);
  this.date = ko.observable(data.display_time);
  this.satisfied = ko.observable(data.satisfied);
  this.wait_bucket = ko.observable(data.wait_bucket);
  this.cleanliness = ko.observable(data.cleanliness);
  this.friendliness = ko.observable(data.staff_friendliness);
  this.drugs_avail = ko.observable(data.drug_availability);
  this.price_display = ko.observable(data.price_display);
  this.message = ko.observable(data.message);

  this.disp_wait = ko.computed(function() {
	return {
	  '<2': '< 2 hrs',
	  '2-4': '2\u20134 hrs',
          '>4': '> 4 hrs',
        }[this.wait_bucket()];
    }, this);
}

ko.bindingHandlers.yn = {
  update: function(element, valueAccessor, allBindingsAccessor, viewModel) {
    var val = ko.utils.unwrapObservable(valueAccessor());

    $(element).empty();
    if (val != null) {
      var $img = $('<img />');
      $img.attr('src', 'http://whereis.dimagi.com/staticmedia/admin/img/icon_' + (val ? 'success' : 'error') + '.gif');
      $(element).append($img);
    }

  }
};


</script>

    <div class="row-fluid">
        <div class="span12">
            <form id="detail-filter" class="form-inline filter-form">
                <label>Feedback on</label>
                <select data-bind="value: active_metric" id="feedback">
                    <option value="all">All</option>
                    <option value="satisf">Overall Satisfaction</option>
                    <option value="wait">Waiting Time</option>
                    <option value="clean">Cleanliness &amp; Hygiene</option>
                    <option value="friendly">Staff Friendliness</option>
                    <option value="drugavail">Drug Availability</option>
                    <option value="pricedisp">Prices Displayed</option>
                </select>
                <label>in</label>
                <select data-bind="options: facilities, value: active_facility, optionsText: 'name'" id="location">
                </select>
            </form>
        </div>
    </div>

    <div class="row-fluid">
        <div class="span12">
            {% include "dashboard/_map.html" %}
        </div>
    </div>

    <div class="row-fluid">
        <div class="span12">
            <span class="large">Detailed Reports</span>
            {% include "dashboard/_table_filter.html" %}
        </div>
    </div>

    <div class="row-fluid">
        <div class="span12">
            <table id="reports-table" class="table table-bordered table-striped table-condensed">
                <thead>
                    <tr>
                        <th>Report #</th>
                        <th style="width: 12em;">Site</th>
                        <th>Date &amp; Time</th>
                        <th data-bind="visible: is_metric_active('satisf')">Patient Satisfied</th>
                        <th data-bind="visible: is_metric_active('wait')">Waiting Time</th>
                        <th data-bind="visible: is_metric_active('clean')">Clean Clinic</th>
                        <th data-bind="visible: is_metric_active('friendly')">Staff Friendly</th>
                        <th data-bind="visible: is_metric_active('drugavail')">Drugs Available</th>
                        <th data-bind="visible: is_metric_active('pricedisp')">Prices Displayed</th>
                        <th data-bind="visible: $root.active_metric() == 'all'">Free-form Entries</th>
			<th data-bind="visible: active_metric() != 'all'">Free-form message</th>
                    </tr>
                </thead>
                <tbody data-bind="foreach: logs">
                    <tr>
                        <td data-bind="text: id"></td>
                        <td data-bind="text: site"></td>
                        <td data-bind="text: date"></td>
                        <td data-bind="yn: satisfied, visible: $root.is_metric_active('satisf')"></td>
                        <td data-bind="text: disp_wait, visible: $root.is_metric_active('wait')"></td>
                        <td data-bind="yn: cleanliness, visible: $root.is_metric_active('clean')"></td>
                        <td data-bind="yn: friendliness, visible: $root.is_metric_active('friendly')"></td>
                        <td data-bind="yn: drugs_avail, visible: $root.is_metric_active('drugavail')"></td>
                        <td data-bind="yn: price_display, visible: $root.is_metric_active('pricedisp')"></td>
                        <td data-bind="yn: message() != null, visible: $root.active_metric() == 'all'"></td>
			<td data-bind="text: message, visible: $root.active_metric() != 'all'"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
{% endblock content %}
